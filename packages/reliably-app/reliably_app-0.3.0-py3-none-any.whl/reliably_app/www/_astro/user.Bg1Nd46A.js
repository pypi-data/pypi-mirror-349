import{a as p}from"./index.BSdFiPHn.js";import{i as w,d as y}from"./loader.BQDlK3Tc.js";import{a as u}from"./notifications.NSMm1_5U.js";let E=0,O=[];function I(){return E+=1,()=>{if(E-=1,E===0){let e=O;O=[];for(let t of e)t()}}}function k(e){let t=I(),n=e().finally(t);return n.t=!0,n}const M=5,g=6,m=10;let P=(e,t,n,s)=>(e.events=e.events||{},e.events[n+m]||(e.events[n+m]=s(o=>{e.events[n].reduceRight((i,a)=>(a(i),i),{shared:{},...o})})),e.events[n]=e.events[n]||[],e.events[n].push(t),()=>{let o=e.events[n],i=o.indexOf(t);o.splice(i,1),o.length||(delete e.events[n],e.events[n+m](),delete e.events[n+m])}),C=1e3,J=(e,t)=>P(e,s=>{let o=t(s);o&&e.events[g].push(o)},M,s=>{let o=e.listen;e.listen=(...a)=>(!e.lc&&!e.active&&(e.active=!0,s()),o(...a));let i=e.off;return e.events[g]=[],e.off=()=>{i(),setTimeout(()=>{if(e.active&&!e.lc){e.active=!1;for(let a of e.events[g])a();e.events[g]=[]}},C)},()=>{e.listen=o,e.off=i}}),D=(e={})=>{let t=p(e);return t.setKey=function(n,s){let o=t.value;typeof s>"u"&&n in t.value?(t.value={...t.value},delete t.value[n],t.notify(o,n)):t.value[n]!==s&&(t.value={...t.value,[n]:s},t.notify(o,n))},t},_=e=>e,f={},T={addEventListener(){},removeEventListener(){}};function B(){try{return typeof localStorage<"u"}catch{return!1}}B()&&(f=localStorage);let W={addEventListener(e,t,n){window.addEventListener("storage",t),window.addEventListener("pageshow",n)},removeEventListener(e,t,n){window.removeEventListener("storage",t),window.removeEventListener("pageshow",n)}};typeof window<"u"&&(T=W);function U(e,t=void 0,n={}){let s=n.encode||_,o=n.decode||_,i=p(t),a=i.set;i.set=l=>{typeof l>"u"?delete f[e]:f[e]=s(l),a(l)};function h(l){l.key===e?l.newValue===null?a(void 0):a(o(l.newValue)):f[e]||a(void 0)}function v(){i.set(f[e]?o(f[e]):t)}return J(i,()=>{if(v(),n.listen!==!1)return T.addEventListener(e,h,v),()=>{T.removeEventListener(e,h,v)}}),i}const $={ASSETS_PREFIX:void 0,BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,PUBLIC_API_URL:"/api",SITE:void 0,SSR:!1},c=$===void 0?"https://62ff903e9350a1e548e1952e.mockapi.io/api":"/api",A=c==="https://62ff903e9350a1e548e1952e.mockapi.io/api",z=A?"1/info/1":"info",V=A?"1/tokens":"tokens",S=p(!1),r=U("reliably:context",""),N=p(""),d=U("reliably:user",{profile:{email:"",username:"",id:"",picture:""},orgs:[]},{encode:JSON.stringify,decode:JSON.parse});function L(e){return S.set(e),S.get()}function j(e){return r.set(e),r.get()}async function F(e){return N.set(e),N.get()}async function Q(){await d.get().orgs.forEach(t=>{t.id===r.get()&&F(t.name)})}const Z=async(e,t,n)=>{let s="/login/with/email";t&&(s=`${s}?join=${n}`);let o=null;try{if(o=await fetch(s,{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(e)}),o.ok){const i=await o.json();return{status:o.status,message:"",api_response:i}}else throw new Error(o.statusText)}catch(i){let a=e.register?"Registration failed":"Login failed";return{status:o===null?520:o.status,message:`${a}: ${i.message}`}}},b=async e=>{d.set({profile:{username:"",email:"",id:"",picture:""},orgs:[]}),await k(async()=>{try{const t=await fetch(`${c}/me/${z}`);if(!t.ok)if(t.status===401)window.location.replace("/login/");else throw new Error(t.statusText);const n=await t.json();r.set(e);let o={profile:{id:n.profile.id,username:n.profile.username,email:n.profile.email,picture:n.profile.openid_profile.picture},orgs:n.orgs};d.set(o),L(!0)}catch(t){const n={title:"We couldn't log you in",message:t.message,type:"error"};u(n)}})},K=async()=>{await k(async()=>{try{const e=await fetch(`${c}/me/${z}`);if(!e.ok)if(e.status===401)window.location.replace("/login/");else throw new Error(e.statusText);const t=await e.json();r.set(t.orgs[0].id);let s={profile:{id:t.profile.id,username:t.profile.username,email:t.profile.email,picture:t.profile.openid_profile.picture},orgs:t.orgs};d.set(s),L(!0)}catch(e){const t={title:"We couldn't log you in",message:e.message,type:"error"};u(t)}})},ee=async()=>{await k(async()=>{r.set(""),d.set({profile:{username:"",email:"",id:"",picture:""},orgs:[]}),L(!1)})},te=async e=>{j(e)},R=D([]);async function X(e){return R.set(e),R.get()}const ne=async()=>{w();const e=`${c}/me/${V}`;try{const n=await(await fetch(e)).json();X(n)}catch(t){const n={title:"Tokens couldn't be fetched",message:t.message,type:"error"};u(n)}finally{y()}},x=p({id:"",name:"",created_date:"",token:""});async function Y(e){return x.set(e),x.get()}const se=async e=>{w();const t=`${c}/organization/${r.get()}/tokens/${e}`;try{const n=await fetch(t);if(!n.ok)throw new Error(n.statusText);const s=await n.json();Y(s)}catch(n){const s={title:"Token couldn't be fetched",message:n.message,type:"error"};u(s)}finally{y()}},oe=async e=>{w();const t=`${c}/organization/${r.get()}/tokens`;try{const n=await fetch(t,{method:"POST",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify({name:e})});if(!n.ok)throw new Error(n.statusText);return await n.json()}catch(n){const s={title:"Token couldn't be created",message:n.message,type:"error"};u(s)}finally{y()}},ie=async(e,t)=>{w();const n=`${c}/organization/${t}/tokens/${e}`;try{const s=await fetch(n,{method:"DELETE"});if(!s.ok)throw new Error(s.statusText)}catch(s){const o={title:"Token couldn't be deleted",message:s.message,type:"error"};u(o)}finally{y()}};export{N as a,ee as b,d as c,oe as d,te as e,F as f,ie as g,ne as h,S as i,se as j,x as k,Z as l,D as m,R as n,r as o,Q as s,b as t,K as u};
