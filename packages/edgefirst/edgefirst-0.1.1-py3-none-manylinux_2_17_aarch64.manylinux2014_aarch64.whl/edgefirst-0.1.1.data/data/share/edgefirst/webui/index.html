<!DOCTYPE html>
<html>

<head>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <p id="timeout" style="color: red;"></p>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Au-Zone demo</title>
    <link href="./css/styles.css" rel="stylesheet">
    <link href="./css/full.css" rel="stylesheet" type="text/css" />

    <script src="./js/tailwind.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
        }

        main {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        #container {
            margin: 0;
            text-align: center;
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: center;
            overflow: hidden;
            background-color: black;
        }

        #test {
            width: 100%;
            height: 100%;
            /* height:width ratio = 9/16 = .5625  */
            max-height: 100%;
            max-width: 100%;
            /* 16/9 = 1.778 */
            margin: auto;
            position: relative;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
        }

        #player_div {
            width: 100%;
            height: 100%;
            max-height: 100%;
            max-width: 100%;
            flex: 1 20 80%;
            display: flex;
            align-items: middle;
            background-color: #a0a0a0;
        }

        #player {
            width: 100%;
            aspect-ratio: 16 / 9;
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            position: relative;
            bottom: 0px;
        }

        #boxes {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        #toggleButton {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }

        .navbar-end .btn-circle svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .navbar-end .btn-circle:hover svg {
            color: #e2e8f0;
        }

        .navbar-end .menu {
            display: flex;
            align-items: center;
        }

        .navbar-end .btn-circle.btn-lg {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .navbar-end .btn-circle.btn-lg svg {
            margin-top: -5px;
            width: 25px;
            height: 25px;
            color: white;
        }

        .navbar-end .btn-circle.btn-lg:hover svg {
            color: #e2e8f0;
        }

        /* Add mode indicator styles */
        #modeIndicator {
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        /* Add recording toggle styles */
        .recording-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 16px;
        }

        .recording-toggle .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .recording-toggle .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .recording-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .recording-toggle .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .recording-toggle input:checked+.slider {
            background-color: #2196F3;
        }

        .recording-toggle input:checked+.slider:before {
            transform: translateX(24px);
        }

        .recording-toggle .toggle-label {
            font-size: 14px;
            color: #4a5568;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <header class="navbar bg-base-100">
        <div class="navbar-start">
            <a href="/" class="btn btn-ghost text-xl"><img class="header__logo me-2" src="assets/auzoneLogo.svg"
                    alt=""></a>
        </div>
        <div class="navbar-center">
            <span class="text-xl">Edgefirst Perception Middleware</span>
        </div>
        <div class="navbar-end">
            <div class="flex items-center gap-4">
                <!-- Add recording toggle -->
                <div class="recording-toggle">
                    <span class="toggle-label">Recording</span>
                    <label class="switch">
                        <input type="checkbox" id="recordingToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <!-- Replace MCAP Files Dropdown with button -->
                <div class="relative">
                    <button class="btn btn-ghost btn-circle" onclick="showMcapDialog()" id="mcapDialogBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>
                </div>
                <!-- Add the recorder indicator -->
                <div id="recorderIndicator" class="hidden relative group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 96 96" fill="currentColor">
                        <circle cx="48" cy="48" r="32" />
                    </svg>
                    <!-- Tooltip -->
                    <div
                        class="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded py-1 px-2 -bottom-8 left-1/2 transform -translate-x-1/2 whitespace-nowrap">
                        Recording
                    </div>
                </div>
                <!-- Mode Indicator with Tooltip -->


                <ul class="menu menu-horizontal px-1">

                </ul>
            </div>
        </div>
    </header>
    <main id="container">
        <div id="test">
            <div id="player_div">
                <canvas id="player"></canvas>
                <canvas id="boxes"></canvas>
            </div>
        </div>
    </main>

    <script type="module" src="./js/segmentation.js"></script>
    <script type="module">
        let lastServiceStatuses = null;
        let lastDeviceData = null;
        let lastReplayStatus = null;
        let lastRecorderStatus = null;
        let isCheckingStatus = false;
        let currentRecordingFile = null;
        let recordingToggleInitialized = false;
        let mcapFiles = [];
        let currentPlayingFile = null;
        let isPlaying = false;
        let mcapSocket = null;
        let isServerAvailable = false;

        // MCAP Dialog Functions
        window.showMcapDialog = function () {
            const dialog = document.getElementById('mcapDialog');
            dialog.classList.remove('hidden');
            dialog.showModal();
            listMcapFiles();
        };

        window.hideMcapDialog = function () {
            const dialog = document.getElementById('mcapDialog');
            dialog.classList.add('hidden');
            dialog.close();
        };

        window.showMcapDetails = function (fileName, directory) {
            const file = mcapFiles.find(f => f.name === fileName);
            if (!file) return;

            const modal = document.getElementById('myModal');
            const modalDetails = document.getElementById('modalDetails');

            modalDetails.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">File Details</h3>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    ${Object.entries(file.topics).map(([topic, details]) => `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="font-medium text-gray-800 mb-2">${topic}</div>
                            <div class="grid grid-cols-[80px,1fr] gap-y-2">
                                <span class="text-gray-600">FPS:</span>
                                <span class="text-gray-800">${details.average_fps.toFixed(2)}</span>
                                <span class="text-gray-600">Frames:</span>
                                <span class="text-gray-800">${details.message_count}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="closeModal()" class="bg-[#4285f4] text-white px-4 py-2 rounded hover:bg-blue-600">
                        CLOSE
                    </button>
                </div>
            `;

            modal.showModal();
        };

        window.closeModal = function () {
            const modal = document.getElementById('myModal');
            modal.close();
        };

        window.deleteFile = function (fileName, directory) {
            if (fileName === currentRecordingFile) {
                alert('Cannot delete file while it is being recorded');
                return;
            }
            if (fileName === currentPlayingFile) {
                alert('Cannot delete file while it is being played');
                return;
            }

            const confirmDelete = confirm(`Are you sure you want to delete: ${fileName}?`);
            if (confirmDelete) {
                fetch('/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        directory: directory,
                        file: fileName
                    })
                }).then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error ${response.status}: ${text}`);
                        });
                    }
                    return response.text();
                }).then(text => {
                    console.log('File deleted:', text);
                    listMcapFiles();
                }).catch(error => {
                    console.error('Error deleting file:', error);
                    alert(`Error deleting file: ${error.message}`);
                });
            }
        };

        // Add function to check server availability
        async function checkServerAvailability() {
            try {
                const response = await fetch('/config/webui/details');
                isServerAvailable = response.ok;
            } catch (error) {
                console.error('Server check failed:', error);
                isServerAvailable = false;
            }
            updateMcapFilesUI();
        }

        function updateMcapFilesUI() {
            const content = document.getElementById('mcapFilesContent');
            if (!mcapFiles || mcapFiles.length === 0) {
                content.innerHTML = `
                    <div class="text-gray-500 text-center py-4">
                        No MCAP files found
                    </div>
                `;
                return;
            }

            // Sort files by creation date (newest first)
            const sortedFiles = [...mcapFiles].sort((a, b) => {
                if (a.name === currentPlayingFile) return -1;
                if (b.name === currentPlayingFile) return 1;
                return new Date(b.created) - new Date(a.created);
            });

            content.innerHTML = sortedFiles.map(file => {
                const isRecording = file.name === currentRecordingFile;
                const isPlaying = file.name === currentPlayingFile;
                const isDisabled = true; // Force disable all play buttons

                const buttonBase = "text-white p-1.5 rounded-full transition-all duration-200";
                const buttonStyles = {
                    play: `${buttonBase} bg-gray-300 opacity-40 cursor-not-allowed pointer-events-none filter grayscale`,
                    info: `${buttonBase} bg-[#4285f4] hover:bg-blue-600`,
                    download: `${buttonBase} bg-[#34a853] hover:bg-[#2d9248]`,
                    delete: `${buttonBase} bg-[#dc3545] hover:bg-red-600 ${isRecording || isPlaying ? 'opacity-50 cursor-not-allowed' : ''}`
                };

                return `
                    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors ${isPlaying ? 'bg-blue-50' : ''}">
                        <div class="flex items-center gap-3">
                            <button class="${buttonStyles.play}" 
                                ${isDisabled ? 'disabled' : ''}
                                ${isDisabled ? '' : `onclick="togglePlayMcap('${file.name}', '${file.directory}')"`}
                                title="${!isServerAvailable ? 'Server not available' : isPlaying ? 'Stop' : 'Play'}">
                                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                                    ${isPlaying ?
                        '<path d="M8 6h8c1.1 0 2 .9 2 2v8c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2V8c0-1.1.9-2 2-2z"/>' :
                        '<path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/>'
                    }
                                </svg>
                            </button>
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-gray-900 ${isPlaying ? 'text-blue-600' : ''}">${file.name}</span>
                                <span class="text-xs text-gray-500">${file.size} MB • ${file.average_video_length.toFixed(2)}s</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${isPlaying ? '<span class="text-xs text-blue-600">Now Playing</span>' : ''}
                            <button class="${buttonStyles.info}" 
                                onclick="showMcapDetails('${file.name}', '${file.directory}')" 
                                title="Show Details">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                </svg>
                            </button>
                            <a class="${buttonStyles.download}"
                                href="/download/${file.directory || ''}/${file.name}"
                                onclick="console.log('Download path:', '/download/${file.directory || ''}/${file.name}'); console.log('File directory:', '${file.directory || ''}'); console.log('File name:', '${file.name}');"
                                download
                                title="Download">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                                </svg>
                            </a>
                            <button class="${buttonStyles.delete}"
                                onclick="deleteFile('${file.name}', '${file.directory}')"
                                ${isRecording || isPlaying ? 'disabled' : ''}
                                title="Delete">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function connectMcapWebSocket() {
            mcapSocket = new WebSocket('/mcap/');

            mcapSocket.onopen = () => {
                console.log('MCAP WebSocket connection established');
                listMcapFiles();
            };

            mcapSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.error) {
                        console.error('Error:', data.error);
                        document.getElementById('mcapFilesContent').innerHTML = `
                            <div class="text-red-600 text-center py-4">
                                Error loading MCAP files: ${data.error}
                            </div>
                        `;
                        return;
                    }
                    mcapFiles = (data.files || []).map(file => ({
                        ...file,
                        directory: data.dir_name || ''
                    }));
                    updateMcapFilesUI();
                } catch (error) {
                    console.error('Error parsing MCAP data:', error);
                    document.getElementById('mcapFilesContent').innerHTML = `
                        <div class="text-red-600 text-center py-4">
                            Error parsing MCAP files data
                        </div>
                    `;
                }
            };

            mcapSocket.onclose = () => {
                console.log('MCAP WebSocket connection closed');
                setTimeout(connectMcapWebSocket, 3000);
            };

            mcapSocket.onerror = (error) => {
                console.error('MCAP WebSocket error:', error);
            };
        }

        function listMcapFiles() {
            if (mcapSocket && mcapSocket.readyState === WebSocket.OPEN) {
                mcapSocket.send(JSON.stringify({ action: 'list_files' }));
            }
        }

        async function loadMcapFiles() {
            if (!mcapSocket || mcapSocket.readyState !== WebSocket.OPEN) {
                connectMcapWebSocket();
            } else {
                listMcapFiles();
            }
        }

        // Initialize MCAP functionality on page load
        window.addEventListener('load', () => {
            connectMcapWebSocket();
        });

        // Define updateRecordingUI first since it's used by other functions
        function updateRecordingUI(isRecording) {
            const recorderIndicator = document.getElementById('recorderIndicator');
            const recorderToggle = document.getElementById('recordingToggle');

            recorderToggle.checked = isRecording;
            if (isRecording) {
                recorderIndicator.classList.remove('hidden');
                recorderIndicator.classList.add('text-red-600', 'animate-pulse');
            } else {
                recorderIndicator.classList.add('hidden');
                recorderIndicator.classList.remove('text-red-600', 'animate-pulse');
            }
        }

        async function checkRecorderStatus() {
            try {
                const response = await fetch('/recorder-status');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const statusText = await response.text();
                const isRecording = statusText.trim() === "Recorder is running";

                if (isRecording) {
                    const currentResponse = await fetch('/current-recording');
                    const data = await currentResponse.json();
                    currentRecordingFile = data.status === "recording" ? data.filename : null;
                } else {
                    currentRecordingFile = null;
                }

                updateRecordingUI(isRecording);
            } catch (error) {
                console.error('Error checking recorder status:', error);
                currentRecordingFile = null;
                updateRecordingUI(false);
            }
        }

        // Add recording toggle functionality
        async function initializeRecordingToggle() {
            const toggle = document.getElementById('recordingToggle');

            // Disable toggle until we know the initial state
            toggle.disabled = true;

            try {
                const response = await fetch('/recorder-status');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const statusText = await response.text();
                const isRecording = statusText.trim() === "Recorder is running";

                // Set initial state
                updateRecordingUI(isRecording);

                // Now enable the toggle and add the event listener
                toggle.disabled = false;
                if (!recordingToggleInitialized) {
                    toggle.addEventListener('change', async function (e) {
                        const isRecording = e.target.checked;
                        const recorderIndicator = document.getElementById('recorderIndicator');

                        try {
                            const response = await fetch(isRecording ? '/start' : '/stop', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({})
                            });

                            if (!response.ok) {
                                // Revert the toggle if the request failed
                                e.target.checked = !isRecording;
                                alert('Failed to toggle recording');
                                return;
                            }

                            updateRecordingUI(isRecording);
                        } catch (error) {
                            console.error('Error toggling recording:', error);
                            e.target.checked = !isRecording;
                            alert('Error toggling recording');
                        }
                    });
                    recordingToggleInitialized = true;
                }
            } catch (error) {
                console.error('Error initializing recording toggle:', error);
                toggle.disabled = true;
            }
        }

        // Initialize recording toggle on page load
        window.addEventListener('load', initializeRecordingToggle);

        async function throttledStatusCheck() {
            if (isCheckingStatus) return;

            try {
                isCheckingStatus = true;
                await Promise.all([
                    checkReplayStatus(),
                    checkRecorderStatus()
                ]);
            } finally {
                isCheckingStatus = false;
            }
        }
        function scheduleStatusCheck() {
            requestAnimationFrame(async () => {
                await throttledStatusCheck();
            });
        }
        let statusCheckInterval;
        window.addEventListener('load', async () => {
            await checkServerAvailability();
            await throttledStatusCheck();
            connectMcapWebSocket();

            // Add periodic server check
            setInterval(checkServerAvailability, 5000);

            statusCheckInterval = setInterval(() => {
                if (document.visibilityState === 'visible') {
                    listMcapFiles();
                    scheduleStatusCheck();
                }
            }, 30000);
        });
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                clearInterval(statusCheckInterval);
            } else {
                clearInterval(statusCheckInterval);
                statusCheckInterval = setInterval(() => {
                    if (document.visibilityState === 'visible') {
                        listMcapFiles();
                        scheduleStatusCheck();
                    }
                }, 30000);
            }
        });
        window.addEventListener('beforeunload', () => {
            clearInterval(statusCheckInterval);
        });

        async function checkReplayStatus() {
            try {

                if (!lastDeviceData) {
                    const deviceResponse = await fetch('/config/webui/details');
                    if (!deviceResponse.ok) throw new Error(`HTTP error! status: ${deviceResponse.status}`);
                    lastDeviceData = await deviceResponse.json();
                }
                const isRaivin = lastDeviceData.DEVICE?.toLowerCase().includes('raivin');

                const services = isRaivin ? ["camera", "model"] : ["camera", "model"];

                const [serviceResponse, replayResponse] = await Promise.all([
                    fetch('/config/service/status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ services })
                    }),
                    fetch('/replay-status')
                ]);

                if (!serviceResponse.ok || !replayResponse.ok) throw new Error('Network response was not ok');

                const serviceStatuses = await serviceResponse.json();
                const statusText = await replayResponse.text();
                const isReplay = statusText.trim() === "Replay is running";

                const statusesChanged = JSON.stringify(serviceStatuses) !== JSON.stringify(lastServiceStatuses);
                const replayChanged = isReplay !== lastReplayStatus;

                if (!statusesChanged && !replayChanged) {
                    return;
                }

                lastServiceStatuses = serviceStatuses;
                lastReplayStatus = isReplay;

                updateStatusUI(serviceStatuses, isReplay, isRaivin, services);
            } catch (error) {
                console.error('Error checking replay status:', error);
                handleStatusError();
            }
        }

        function updateStatusUI(serviceStatuses, isReplay, isRaivin, services) {
            const statusMap = serviceStatuses.reduce((acc, { service, status }) => {
                acc[service] = status;
                return acc;
            }, {});

            const modeIndicator = document.getElementById('modeIndicator');
            const modeText = document.getElementById('modeText');
            const loadingSpinner = modeIndicator.querySelector('svg.animate-spin');

            if (loadingSpinner) {
                loadingSpinner.remove();
            }

            const allSensorsInactive = services.every(service => statusMap[service] !== 'running');
            const allSensorActive = services.every(service => statusMap[service] === 'running');
            if (allSensorsInactive && !isReplay) {
                modeText.textContent = "Stopped";
                modeIndicator.className = "px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 flex items-center gap-2";
            }
            else if (isReplay) {
                if (!allSensorsInactive) {
                    modeText.textContent = "Replay Mode (Degraded)";
                    modeIndicator.className = "px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 flex items-center gap-2";
                } else {
                    modeText.textContent = "Replay Mode";
                    modeIndicator.className = "px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 flex items-center gap-2";
                }
            } else {
                const isCameraDown = !statusMap['camera'] || statusMap['camera'] !== 'running';
                const isradarpubDown = !statusMap['radarpub'] || statusMap['radarpub'] !== 'running';
                const isDegraded = (isRaivin && isradarpubDown) || isCameraDown;

                if (!allSensorActive) {
                    modeText.textContent = "Live Mode (Degraded)";
                    modeIndicator.className = "px-3 py-1 rounded-full text-sm font-medium bg-amber-100 text-amber-800 flex items-center gap-2";
                } else {
                    modeText.textContent = "Live Mode";
                    modeIndicator.className = "px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 flex items-center gap-2";
                }
            }
            updateQuickStatus();
        }

        async function updateQuickStatus() {
            try {
                const isRaivin = lastDeviceData.DEVICE?.toLowerCase().includes('raivin');
                const baseServices = ["camera", "model"];
                const raivinServices = ["radarpub", "fusion"];
                const services = isRaivin ? [...baseServices, ...raivinServices] : baseServices;

                if (!lastServiceStatuses) {
                    const response = await fetch('/config/service/status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ services })
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    lastServiceStatuses = await response.json();
                }

                updateQuickStatusUI(lastServiceStatuses);
            } catch (error) {
                console.error('Error updating quick status:', error);
                handleQuickStatusError();
            }
        }

        function updateQuickStatusUI(serviceStatuses) {
            const quickStatusContent = document.getElementById('quickStatusContent');
            const nonRunningServices = serviceStatuses.filter(({ status }) => status !== 'running');

            if (nonRunningServices.length === 0) {
                quickStatusContent.innerHTML = `
                    <div class="flex items-center justify-center text-green-600">
                        <span class="h-2 w-2 rounded-full bg-green-500 mr-2"></span>
                        All Services Running
                    </div>
                `;
            } else {
                quickStatusContent.innerHTML = `
                    <div class="text-red-600 mb-2">
                        <span class="h-2 w-2 rounded-full bg-red-500 mr-2 inline-block"></span>
                        Inactive Services:
                    </div>
                `;

                nonRunningServices.forEach(({ service }) => {
                    const serviceName = service
                        .replace('.service', '')
                        .split('-')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');

                    quickStatusContent.innerHTML += `
                        <div class="flex items-center justify-between text-gray-600">
                            <span>${serviceName}</span>
                            <span class="text-red-500">Inactive</span>
                        </div>
                    `;
                });
            }

            quickStatusContent.innerHTML += `
                <button onclick="showServiceStatus()" class="w-full mt-4 text-sm text-blue-600 hover:text-blue-800 flex items-center justify-center gap-1">
                    <span>Click for more details</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            `;
        }

        window.showServiceStatus = async function () {
            const dialog = document.getElementById('serviceStatusDialog');
            const content = document.getElementById('serviceStatusContent');

            dialog.classList.remove('hidden');

            try {
                const deviceResponse = await fetch('/config/webui/details');
                if (!deviceResponse.ok) throw new Error(`HTTP error! status: ${deviceResponse.status}`);
                const deviceData = await deviceResponse.json();
                const isRaivin = deviceData.DEVICE?.toLowerCase().includes('raivin');

                const baseServices = ["camera", "model"];
                const raivinServices = ["radarpub", "fusion"];
                const services = isRaivin ? [...baseServices, ...raivinServices] : baseServices;

                const response = await fetch('/config/service/status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ services })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const serviceStatuses = await response.json();
                content.innerHTML = ''; // Clear existing content

                // Create status items for each service
                serviceStatuses.forEach(({ service, status, enabled }) => {
                    const isRunning = status === 'running';
                    const isEnabled = enabled === 'enabled';

                    const statusColor = isRunning ? 'bg-green-500' : 'bg-red-500';
                    const enabledColor = isEnabled ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600';

                    const serviceName = service
                        .replace('.service', '')
                        .split('-')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');

                    content.innerHTML += `
                        <div class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors">
                            <div class="flex flex-col gap-1">
                                <span class="text-sm font-medium text-gray-900">${serviceName}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${enabledColor} inline-flex items-center w-fit">
                                    ${isEnabled ? 'Enabled' : 'Disabled'}
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium ${isRunning ? 'text-green-600' : 'text-red-600'}">
                                    ${isRunning ? 'Running' : 'Stopped'}
                                </span>
                                <div class="w-2 h-2 rounded-full ${statusColor}"></div>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error fetching service status:', error);
                content.innerHTML = `
                    <div class="flex items-center gap-2 p-3 text-red-800 bg-red-50 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-sm font-medium">Error loading service status</span>
                    </div>
                `;
            }
        };

        window.hideServiceStatus = function () {
            document.getElementById('serviceStatusDialog').classList.add('hidden');
        };

        function handleStatusError() {
            const modeIndicator = document.getElementById('modeIndicator');
            const modeText = document.getElementById('modeText');
            const loadingSpinner = modeIndicator.querySelector('svg.animate-spin');
            if (loadingSpinner) loadingSpinner.remove();
            modeText.textContent = "Status Unknown";
            modeIndicator.className = "px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 flex items-center gap-2";
        }

        function handleQuickStatusError() {
            const quickStatusContent = document.getElementById('quickStatusContent');
            quickStatusContent.innerHTML = `
                <div class="text-red-600">
                    Error checking service status
                </div>
            `;
        }

        window.togglePlayMcap = function (fileName, directory) {
            if (fileName === currentPlayingFile) {
                fetch('/stop-replay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                }).then(response => {
                    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                    currentPlayingFile = null;
                    isPlaying = false;
                    updateMcapFilesUI();
                }).catch(error => {
                    console.error('Error stopping replay:', error);
                    alert('Error stopping replay');
                });
            } else {
                fetch('/start-replay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        directory: directory,
                        file: fileName
                    })
                }).then(response => {
                    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                    currentPlayingFile = fileName;
                    isPlaying = true;
                    updateMcapFilesUI();
                }).catch(error => {
                    console.error('Error starting replay:', error);
                    alert('Error starting replay');
                });
            }
        };
    </script>

    <!-- Service Status Dialog -->
    <div id="serviceStatusDialog"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="p-6">
                <div class="flex items-center justify-between gap-2 mb-4 pb-3 border-b border-gray-100">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7zM5 18v2h14v-2H5z" />
                        </svg>
                        <h3 class="text-xl font-semibold text-gray-800">System Status</h3>
                    </div>
                    <button onclick="hideServiceStatus()"
                        class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="serviceStatusContent" class="space-y-3 overflow-y-auto max-h-[60vh]">
                </div>
            </div>
        </div>
    </div>

    <!-- Add MCAP Files Dialog before the Service Status Dialog -->
    <dialog id="mcapDialog" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 rounded-lg">
        <div class="bg-white rounded-xl shadow-lg w-[480px] max-h-[90vh] overflow-hidden">
            <div class="p-6">
                <div class="flex items-center justify-between gap-2 mb-4 pb-3 border-b border-gray-100">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <h3 class="text-xl font-semibold text-gray-800">MCAP Files</h3>
                    </div>
                    <button onclick="hideMcapDialog()"
                        class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="mcapFilesContent" class="space-y-2 overflow-y-auto max-h-[60vh]">
                    <div class="text-gray-500 text-center py-4">Loading MCAP files...</div>
                </div>
            </div>
        </div>
    </dialog>

    <dialog id="myModal" class="bg-white rounded-lg shadow-lg p-6 w-[600px]">
        <div id="modalDetails"></div>
    </dialog>
</body>

</html>